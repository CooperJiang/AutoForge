# å·¥ä½œæµèŠ‚ç‚¹è¯´æ˜

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
å¤–éƒ¨è¯·æ±‚                   è‡ªåŠ¨å¤„ç†                     è¿”å›ç»“æœ
   â†“                         â†“                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§¦å‘èŠ‚ç‚¹ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ OpenAI   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ API è¿”å› â”‚
â”‚         â”‚  ä¼ é€’å‚æ•°    â”‚  Chat    â”‚  è¿”å› content   â”‚   ç»“æœ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†•
                        è‡ªåŠ¨è¯»å†™ Redis
                    ï¼ˆå¼•æ“ä¸­é—´ä»¶ç®¡ç†ï¼‰
```

---

## ğŸ” èŠ‚ç‚¹è¯¦è§£

### èŠ‚ç‚¹ 1: å¤–éƒ¨ API è§¦å‘ï¼ˆtrigger_startï¼‰

**ä½œç”¨**ï¼šæ¥æ”¶å¤–éƒ¨ HTTP è¯·æ±‚

**è¾“å…¥å‚æ•°**ï¼ˆé€šè¿‡ POST Body ä¼ å…¥ï¼‰ï¼š
```json
{
  "params": {
    "session_id": "ç”¨æˆ·å”¯ä¸€æ ‡è¯†",
    "user_input": "ç”¨æˆ·å‘é€çš„æ¶ˆæ¯"
  }
}
```

**è¾“å‡º**ï¼šå°† `params` ä¼ é€’ç»™ä¸‹æ¸¸èŠ‚ç‚¹

---

### èŠ‚ç‚¹ 2: OpenAI Chatï¼ˆchat_with_memoryï¼‰

**ä½œç”¨**ï¼šè¿™æ˜¯**å”¯ä¸€çš„æ ¸å¿ƒèŠ‚ç‚¹**ï¼Œå®Œæˆä»¥ä¸‹æ‰€æœ‰å·¥ä½œï¼š

#### ç¬¬ 1 æ­¥ï¼šè‡ªåŠ¨è¯»å–å†å²ï¼ˆå¼•æ“ä¸­é—´ä»¶ï¼‰
```
if (context_config.enabled) {
  ä» Redis è¯»å– key = "chat:context:{session_id}"
  è·å–å†å²æ¶ˆæ¯æ•°ç»„ [
    {role: "system", content: "..."},
    {role: "user", content: "ä¸Šä¸€è½®å¯¹è¯"},
    {role: "assistant", content: "ä¸Šä¸€è½®å›å¤"},
    ...
  ]
}
```

#### ç¬¬ 2 æ­¥ï¼šæ‹¼æ¥å½“å‰æ¶ˆæ¯ï¼ˆå¼•æ“ä¸­é—´ä»¶ï¼‰
```
messages.push({
  role: "user",
  content: "{{params.user_input}}"  // å½“å‰ç”¨æˆ·è¾“å…¥
})

è‡ªåŠ¨è£å‰ªåˆ° window_size = 10 æ¡
```

#### ç¬¬ 3 æ­¥ï¼šè°ƒç”¨ OpenAI APIï¼ˆå·¥å…·æ‰§è¡Œï¼‰
```
POST https://api.openai.com/v1/chat/completions
{
  "model": "gpt-3.5-turbo",
  "messages": [...æ‹¼æ¥å¥½çš„å®Œæ•´å¯¹è¯å†å²],
  "temperature": 0.7
}
```

#### ç¬¬ 4 æ­¥ï¼šè·å– AI å›å¤
```
OpenAI è¿”å›ï¼š
{
  "choices": [{
    "message": {
      "role": "assistant",
      "content": "AI çš„å›å¤å†…å®¹"
    }
  }]
}
```

#### ç¬¬ 5 æ­¥ï¼šè‡ªåŠ¨ä¿å­˜å†å²ï¼ˆå¼•æ“ä¸­é—´ä»¶ï¼‰
```
messages.push({
  role: "assistant",
  content: "AI çš„å›å¤å†…å®¹"
})

ä¿å­˜åˆ° Redis:
key = "chat:context:{session_id}"
value = JSON.stringify(messages)
TTL = 604800 ç§’ï¼ˆ7å¤©ï¼‰
```

#### ç¬¬ 6 æ­¥ï¼šè¿”å›ç»“æœ
```
èŠ‚ç‚¹è¾“å‡ºï¼š
{
  "content": "AI çš„å›å¤å†…å®¹",
  "model": "gpt-3.5-turbo",
  "finish_reason": "stop",
  "total_tokens": 156,
  ...
}
```

---

## ï¿½ï¿½ API è¿”å›ç»“æ„

å½“ä½ è°ƒç”¨å·¥ä½œæµ API æ—¶ï¼Œä¼šå¾—åˆ°ä»¥ä¸‹è¿”å›ï¼š

```json
{
  "success": true,
  "message": "å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ",
  "output": {
    "chat_with_memory": {
      "content": "AI çš„å®Œæ•´å›å¤å†…å®¹",  // â† è¿™å°±æ˜¯ä½ è¦çš„èŠå¤©å†…å®¹
      "model": "gpt-3.5-turbo",
      "prompt_tokens": 85,
      "completion_tokens": 71,
      "total_tokens": 156,
      "finish_reason": "stop",
      "response": {
        "id": "chatcmpl-xxx",
        "object": "chat.completion",
        "created": 1234567890,
        "choices": [...],
        "usage": {...}
      }
    }
  },
  "execution_id": "xxx-xxx-xxx",
  "duration_ms": 1234
}
```

**å…³é”®å­—æ®µ**ï¼š
- `output.chat_with_memory.content` - AI çš„å›å¤æ–‡æœ¬
- `output.chat_with_memory.model` - ä½¿ç”¨çš„æ¨¡å‹
- `output.chat_with_memory.total_tokens` - æ¶ˆè€—çš„ token æ•°

---

## ğŸ§ª å®Œæ•´æµ‹è¯•ç¤ºä¾‹

### å¯¼å…¥å·¥ä½œæµ

æ–‡ä»¶ï¼š`openai_redis_memory_v2_fixed.json`

### æµ‹è¯•å¯¹è¯ï¼ˆå‡è®¾å·¥ä½œæµ ID = `wf123`ï¼‰

#### å¯¹è¯ 1ï¼šè‡ªæˆ‘ä»‹ç»

```bash
curl -X POST http://localhost:7777/api/v1/workflows/wf123/execute \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "session_id": "user_alice",
      "user_input": "ä½ å¥½ï¼æˆ‘å« Aliceï¼Œæˆ‘æ˜¯ä¸€åè®¾è®¡å¸ˆï¼Œå–œæ¬¢æ—…æ¸¸å’Œæ‘„å½±ã€‚"
    }
  }'
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "output": {
    "chat_with_memory": {
      "content": "ä½ å¥½ Aliceï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚è®¾è®¡å¸ˆçš„å·¥ä½œä¸€å®šå¾ˆæœ‰åˆ›æ„ï¼Œè€Œä¸”æ—…æ¸¸å’Œæ‘„å½±çš„çˆ±å¥½ä¹Ÿèƒ½ä¸ºä½ çš„è®¾è®¡å¸¦æ¥å¾ˆå¤šçµæ„Ÿå§ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ",
      "model": "gpt-3.5-turbo",
      "total_tokens": 142
    }
  }
}
```

#### å¯¹è¯ 2ï¼šæµ‹è¯•è®°å¿†

```bash
curl -X POST http://localhost:7777/api/v1/workflows/wf123/execute \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "session_id": "user_alice",
      "user_input": "æˆ‘çš„åå­—æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘çš„èŒä¸šå’Œçˆ±å¥½æ˜¯ä»€ä¹ˆï¼Ÿ"
    }
  }'
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "output": {
    "chat_with_memory": {
      "content": "ä½ çš„åå­—æ˜¯ Aliceï¼Œä½ æ˜¯ä¸€åè®¾è®¡å¸ˆï¼Œå–œæ¬¢æ—…æ¸¸å’Œæ‘„å½±ã€‚",
      "model": "gpt-3.5-turbo",
      "total_tokens": 98
    }
  }
}
```

âœ… **æˆåŠŸï¼** AI å‡†ç¡®è®°ä½äº†ä½ çš„ä¿¡æ¯ï¼

#### å¯¹è¯ 3ï¼šåŸºäºä¸Šä¸‹æ–‡çš„æ¨è

```bash
curl -X POST http://localhost:7777/api/v1/workflows/wf123/execute \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "session_id": "user_alice",
      "user_input": "æ ¹æ®æˆ‘çš„å…´è¶£ï¼Œä½ èƒ½æ¨èä¸€äº›æ—…æ¸¸ç›®çš„åœ°å—ï¼Ÿ"
    }
  }'
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "output": {
    "chat_with_memory": {
      "content": "åŸºäºä½ å–œæ¬¢æ‘„å½±å’Œæ—…æ¸¸ï¼Œæˆ‘æ¨èä»¥ä¸‹ç›®çš„åœ°ï¼š\n1. å†°å²› - æå…‰å’Œå£®ä¸½çš„è‡ªç„¶é£å…‰\n2. æ—¥æœ¬äº¬éƒ½ - ä¼ ç»Ÿå»ºç­‘å’Œå››å­£ç¾æ™¯\n3. æ–°è¥¿å…°å—å²› - æ¹–å…‰å±±è‰²ï¼Œæ‘„å½±å¸ˆçš„å¤©å ‚\n4. æ‘©æ´›å“¥ - è‰²å½©æ–‘æ–“çš„è¡—é“å’Œå¼‚åŸŸé£æƒ…\n5. æŒªå¨å³¡æ¹¾ - éœ‡æ’¼çš„è‡ªç„¶æ™¯è§‚",
      "model": "gpt-3.5-turbo",
      "total_tokens": 215
    }
  }
}
```

âœ… **æˆåŠŸï¼** AI åŸºäºä½ æ˜¯è®¾è®¡å¸ˆ + å–œæ¬¢æ‘„å½±çš„èƒŒæ™¯ï¼Œç»™å‡ºäº†ä¸ªæ€§åŒ–æ¨èï¼

---

## ğŸ” Redis å­˜å‚¨æŸ¥çœ‹

```bash
# æŸ¥çœ‹ Alice çš„å¯¹è¯å†å²
redis-cli GET "chat:context:user_alice"
```

**è¿”å›**ï¼š
```json
[
  {
    "role": "system",
    "content": "ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€ä¸“ä¸šçš„ AI åŠ©æ‰‹..."
  },
  {
    "role": "user",
    "content": "ä½ å¥½ï¼æˆ‘å« Aliceï¼Œæˆ‘æ˜¯ä¸€åè®¾è®¡å¸ˆï¼Œå–œæ¬¢æ—…æ¸¸å’Œæ‘„å½±ã€‚"
  },
  {
    "role": "assistant",
    "content": "ä½ å¥½ Aliceï¼å¾ˆé«˜å…´è®¤è¯†ä½ ..."
  },
  {
    "role": "user",
    "content": "æˆ‘çš„åå­—æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘çš„èŒä¸šå’Œçˆ±å¥½æ˜¯ä»€ä¹ˆï¼Ÿ"
  },
  {
    "role": "assistant",
    "content": "ä½ çš„åå­—æ˜¯ Aliceï¼Œä½ æ˜¯ä¸€åè®¾è®¡å¸ˆï¼Œå–œæ¬¢æ—…æ¸¸å’Œæ‘„å½±ã€‚"
  },
  {
    "role": "user",
    "content": "æ ¹æ®æˆ‘çš„å…´è¶£ï¼Œä½ èƒ½æ¨èä¸€äº›æ—…æ¸¸ç›®çš„åœ°å—ï¼Ÿ"
  },
  {
    "role": "assistant",
    "content": "åŸºäºä½ å–œæ¬¢æ‘„å½±å’Œæ—…æ¸¸ï¼Œæˆ‘æ¨èä»¥ä¸‹ç›®çš„åœ°..."
  }
]
```

---

## â“ å¸¸è§ç–‘é—®è§£ç­”

### Q: ä¸ºä»€ä¹ˆåªæœ‰ 2 ä¸ªèŠ‚ç‚¹ï¼Ÿ

**A**: å› ä¸º**å¼•æ“ä¸­é—´ä»¶è‡ªåŠ¨å¤„ç†äº†ä¸€åˆ‡**ï¼

æ—§æ¶æ„éœ€è¦ 5 ä¸ªèŠ‚ç‚¹ï¼š
1. è§¦å‘
2. Redis GETï¼ˆè¯»å†å²ï¼‰
3. OpenAI Chatï¼ˆå¯¹è¯ï¼‰
4. JSON Transformï¼ˆæ‹¼æ¥å†å²ï¼‰
5. Redis SETï¼ˆä¿å­˜å†å²ï¼‰

æ–°æ¶æ„åªéœ€ 2 ä¸ªèŠ‚ç‚¹ï¼š
1. è§¦å‘
2. OpenAI Chatï¼ˆ**å¼•æ“è‡ªåŠ¨å®Œæˆ 2~5 æ­¥**ï¼‰

### Q: OpenAI èŠ‚ç‚¹åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ

**A**: OpenAI èŠ‚ç‚¹æœ¬èº«åªè´Ÿè´£**è°ƒç”¨ OpenAI API**ï¼Œä½†å¼•æ“åœ¨æ‰§è¡Œå‰åä¼šè‡ªåŠ¨ï¼š

**æ‰§è¡Œå‰**ï¼ˆä¸­é—´ä»¶ï¼‰ï¼š
- æ£€æµ‹åˆ° `context_config.enabled = true`
- ä» Redis è¯»å–å†å²
- æ‹¼æ¥åˆ° `messages_json`
- ä¼ ç»™ OpenAI å·¥å…·

**æ‰§è¡Œä¸­**ï¼ˆå·¥å…·ï¼‰ï¼š
- è°ƒç”¨ OpenAI API
- è·å– AI å›å¤

**æ‰§è¡Œå**ï¼ˆä¸­é—´ä»¶ï¼‰ï¼š
- å°† AI å›å¤è¿½åŠ åˆ°å†å²
- ä¿å­˜åˆ° Redis

### Q: æ¥å£è¿”å›çš„å°±æ˜¯èŠå¤©å†…å®¹å—ï¼Ÿ

**A**: æ˜¯çš„ï¼è¿”å›çš„ `output.chat_with_memory.content` å°±æ˜¯ AI çš„å®Œæ•´å›å¤ã€‚

### Q: å¦‚æœä¸éœ€è¦è®°å¿†åŠŸèƒ½å‘¢ï¼Ÿ

**A**: åœ¨èŠ‚ç‚¹é…ç½®ä¸­ï¼Œå–æ¶ˆå‹¾é€‰"å¯ç”¨å¯¹è¯è®°å¿†"å³å¯ã€‚æ­¤æ—¶å°±æ˜¯æ™®é€šçš„å•è½®å¯¹è¯ã€‚

---

## ğŸ“ æ–‡ä»¶æ¸…å•

- âœ… `openai_redis_memory_v2_fixed.json` - ä¿®å¤åçš„å·¥ä½œæµé…ç½®
- âœ… `WORKFLOW_EXPLANATION.md` - æœ¬æ–‡æ¡£ï¼ˆèŠ‚ç‚¹è¯¦è§£ï¼‰
- âœ… `MIGRATION_GUIDE.md` - æ–°æ—§æ¶æ„å¯¹æ¯”
- âœ… `TEST_CHAT_CONTEXT.md` - å®Œæ•´æŠ€æœ¯æ–‡æ¡£

---

## ğŸ¯ æ€»ç»“

**æ–°æ¶æ„åªéœ€ 2 ä¸ªèŠ‚ç‚¹**ï¼š

1. **å¤–éƒ¨è§¦å‘** - æ¥æ”¶å‚æ•°
2. **OpenAI Chat** - è‡ªåŠ¨è®°å¿† + å¯¹è¯ + è¿”å›ç»“æœ

**å¼•æ“ä¸­é—´ä»¶è‡ªåŠ¨å¤„ç†**ï¼š
- âœ… Redis è¯»å–
- âœ… æ¶ˆæ¯æ‹¼æ¥
- âœ… çª—å£è£å‰ª
- âœ… Redis ä¿å­˜

**ç”¨æˆ·åªéœ€å…³å¿ƒ**ï¼š
- ä¼ å…¥ `session_id` å’Œ `user_input`
- è·å– `content`ï¼ˆAI å›å¤ï¼‰

å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ï¿½ï¿½ï¿½
