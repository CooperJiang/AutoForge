# 飞书机器人工具使用指南

> 通过飞书机器人 Webhook 发送各种类型的消息通知

## 📋 功能特性

- ✅ **文本消息**：简单的纯文本通知
- ✅ **富文本消息**：支持 Markdown 格式的格式化文本
- ✅ **图片消息**：发送图片（需要公网 URL）
- ✅ **卡片消息**：精美的卡片样式消息
  - 通知卡片
  - 告警卡片
  - 报告卡片
  - 自定义卡片
- ✅ **签名验证**：支持飞书签名验证，提高安全性

---

## 🚀 快速开始

### 步骤 1：创建飞书机器人

1. 在飞书中创建一个群聊（可以只有你一个人）
2. 进入群聊，点击右上角 "..." → "设置" → "群机器人"
3. 点击 "添加机器人" → "自定义机器人"
4. 填写机器人名称（如：AutoForge 通知）
5. 选择安全设置：
   - **签名校验**（推荐）：记录签名密钥
   - **关键词**：设置必须包含的关键词
   - **IP 白名单**：限制来源 IP
6. 点击完成，**复制 Webhook URL**

### 步骤 2：在工作流中配置

1. 在工作流编辑器中添加"飞书机器人"节点
2. 填写 Webhook URL
3. 选择消息类型并配置内容
4. **使用变量助手**：点击"显示变量助手"按钮可引用前置节点的输出数据
5. 保存工作流

### 💡 变量使用技巧

所有文本输入字段（Webhook URL、标题、内容等）都支持使用变量：

**变量格式**：
- 节点输出：`{{nodes.node_xxx.字段名}}`
- 环境变量：`{{env.变量名}}`

**示例**：
```
标题：{{nodes.http_001.data.title}}
内容：任务执行状态：{{nodes.http_001.success}}
      返回消息：{{nodes.http_001.message}}
```

**变量助手功能**：
- 点击"显示变量助手"查看所有可用变量
- 显示前置节点的常见输出字段
- 点击字段按钮直接插入到光标位置
- 支持环境变量引用

---

## 📝 消息类型详解

### 1️⃣ 文本消息

最简单的消息类型，适合快速通知。

**配置示例**：
```
消息类型：文本消息
消息内容：您的定时任务已执行完成！
```

**效果**：
```
您的定时任务已执行完成！
```

---

### 2️⃣ 富文本消息

支持 Markdown 格式，适合需要格式化的通知。

**配置示例**：
```
消息类型：富文本消息
标题：工作流执行通知
富文本内容：
**任务名称**：数据同步
**执行状态**：成功 ✅
**执行时间**：2025-01-13 14:30:00
**耗时**：2.5秒

查看详情：[点击这里](https://task.mmmss.com)
```

**支持的格式**：
- `**粗体**` - 粗体文本
- `*斜体*` - 斜体文本
- `[链接文字](URL)` - 超链接
- `- 列表项` - 列表

---

### 3️⃣ 图片消息

发送图片，图片必须是公网可访问的 URL。

**配置示例**：
```
消息类型：图片消息
图片 URL：https://example.com/report-chart.png
```

**注意事项**：
- 图片必须是公网可访问的 URL
- 支持的格式：PNG、JPG、GIF
- 文件大小：< 10MB
- 建议先上传到云存储（阿里云 OSS、腾讯云 COS 等）

---

### 4️⃣ 卡片消息

最强大的消息类型，支持结构化数据展示和交互按钮。

#### 📌 通知卡片

适用于：成功通知、完成提醒

**配置示例**：
```
消息类型：卡片消息
卡片模板：通知卡片
标题：工作流执行成功
内容：数据同步任务已成功完成
状态：成功
字段列表：
[
  {"key":"任务名称","value":"数据同步"},
  {"key":"执行时间","value":"14:30:00"},
  {"key":"处理记录","value":"100条"}
]
按钮列表：
[
  {"text":"查看详情","url":"https://task.mmmss.com/workflows/123"}
]
```

**效果**：
```
┌─────────────────────────┐
│  ✅ 工作流执行成功        │
├─────────────────────────┤
│  数据同步任务已成功完成   │
│                         │
│  任务名称：数据同步       │
│  执行时间：14:30:00      │
│  处理记录：100条         │
│                         │
│  [查看详情]             │
└─────────────────────────┘
```

#### ⚠️ 告警卡片

适用于：错误告警、异常通知

**配置示例**：
```
消息类型：卡片消息
卡片模板：告警卡片
标题：系统告警
内容：数据库连接失败，请及时处理
状态：错误
字段列表：
[
  {"key":"告警级别","value":"高"},
  {"key":"告警时间","value":"14:30:00"},
  {"key":"影响范围","value":"数据同步模块"}
]
按钮列表：
[
  {"text":"立即处理","url":"https://task.mmmss.com/alerts/456"}
]
```

**效果**：
```
┌─────────────────────────┐
│  ❌ 系统告警             │
├─────────────────────────┤
│  数据库连接失败，请及时处理│
│                         │
│  告警级别：高            │
│  告警时间：14:30:00      │
│  影响范围：数据同步模块   │
│                         │
│  [立即处理]             │
└─────────────────────────┘
```

#### 📊 报告卡片

适用于：数据报告、统计信息

**配置示例**：
```
消息类型：卡片消息
卡片模板：报告卡片
标题：今日数据报告
内容：数据统计汇总
状态：信息
字段列表：
[
  {"key":"新增用户","value":"123"},
  {"key":"活跃用户","value":"456"},
  {"key":"订单量","value":"78"},
  {"key":"营收","value":"¥12,345"}
]
按钮列表：
[
  {"text":"详细报告","url":"https://task.mmmss.com/reports/789"},
  {"text":"导出数据","url":"https://task.mmmss.com/reports/789/export"}
]
```

---

## 🔐 安全设置

### 签名验证（推荐）

签名验证可以防止 Webhook URL 被盗用。

**配置方法**：
1. 创建机器人时选择"签名校验"
2. 记录飞书提供的签名密钥
3. 在工具配置中填写"签名密钥"字段

**工作原理**：
- AutoForge 使用签名密钥对消息进行 HMAC-SHA256 签名
- 飞书验证签名后才接受消息
- 即使 Webhook URL 泄露，没有签名密钥也无法发送消息

---

## 💡 使用场景示例

### 场景 1：定时任务通知

```
触发器：每天早上 9:00
↓
HTTP 请求：获取数据
↓
飞书推送（文本消息）：
"今日数据同步已完成，共处理 100 条记录"
```

### 场景 2：错误告警

```
HTTP 请求：健康检查
↓
条件判断：状态码 ≠ 200
↓
飞书推送（告警卡片）：
标题："服务异常告警"
状态：错误
内容：API 健康检查失败
```

### 场景 3：数据报告

```
触发器：每周一早上 9:00
↓
数据库查询：统计上周数据
↓
飞书推送（报告卡片）：
标题："上周数据周报"
字段：各项数据指标
按钮：查看详情、导出
```

---

## 🐛 常见问题

### Q1：收不到消息怎么办？

**检查清单**：
1. ✅ Webhook URL 是否正确
2. ✅ 机器人是否已添加到群里
3. ✅ 如果使用签名验证，密钥是否正确
4. ✅ 如果使用关键词，消息是否包含关键词
5. ✅ 检查工作流执行日志中的错误信息

### Q2：图片无法显示？

**原因**：
- 图片 URL 不是公网可访问
- 图片格式不支持
- 图片文件过大

**解决方案**：
1. 将图片上传到云存储（阿里云 OSS、腾讯云 COS）
2. 使用图片的公网访问 URL
3. 确保图片大小 < 10MB

### Q3：卡片字段 JSON 格式错误？

**正确格式**：
```json
[
  {"key":"字段名1","value":"字段值1"},
  {"key":"字段名2","value":"字段值2"}
]
```

**注意**：
- 使用英文双引号 `"`
- JSON 格式必须正确
- 可以使用在线 JSON 验证工具检查

### Q4：签名验证失败？

**检查**：
1. 签名密钥是否正确（不要有多余空格）
2. 签名密钥是否对应当前的 Webhook URL
3. 如果更新了机器人，需要重新获取密钥

---

## 📚 参考资料

- [飞书开放平台 - 自定义机器人](https://open.feishu.cn/document/client-docs/bot-v3/add-custom-bot)
- [飞书开放平台 - 消息卡片](https://open.feishu.cn/document/common-capabilities/message-card/message-cards-content/using-markdown-tags)
- [飞书开放平台 - 签名验证](https://open.feishu.cn/document/client-docs/bot-v3/add-custom-bot#f62e72d5)

---

## 🎯 最佳实践

1. **使用签名验证**：提高安全性
2. **合理使用卡片**：重要通知使用卡片，一般通知使用文本
3. **添加按钮**：提供快速操作入口
4. **结构化字段**：使用字段列表展示关键信息
5. **选择合适的状态**：success、warning、error、info
6. **控制推送频率**：避免消息过多骚扰

---

**维护者**: AutoForge Team
**最后更新**: 2025-10-13
